datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum AccountStatus {
  ACTIVE
  OVERDRAFT
  SUSPENDED
}

model User {
  id                   String         @id @default(cuid())
  email                String         @unique
  passwordHash         String
  uidToken             String         @unique

  walletBalanceUsd     Float          @default(0)
  lifetimeChargedUsd   Float          @default(0)
  lifetimeStorageCostUsd Float        @default(0)
  lifetimeCdnCostUsd   Float          @default(0)

  accountStatus        AccountStatus  @default(ACTIVE)
  overdraftAt          DateTime?

  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  invites              Invite[]       @relation("UserInvites")
  billingMonths        BillingMonth[]
  fileObjects          FileObject[]

  @@map("users")
}

model Invite {
  id           String   @id @default(cuid())
  code         String   @unique
  expiresAt    DateTime? @map("expires_at")
  usedByUserId String?  @map("used_by_user_id")
  usedAt       DateTime? @map("used_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  user         User?     @relation("UserInvites", fields: [usedByUserId], references: [id])

  @@map("invites")
}

model BillingMonth {
  id             String   @id @default(cuid())
  userId         String

  year           Int
  month          Int

  storageCostUsd Float    @default(0)
  cdnCostUsd     Float    @default(0)

  storageGbDays  Float    @default(0)
  cdnBytes       BigInt   @default(0)
  cdnHits        BigInt   @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id])

  @@unique([userId, year, month])
}

model FileObject {
  id           String   @id @default(cuid())
  ownerId      String
  rootUid      String

  fullPath     String
  relativePath String
  parentPath   String
  name         String

  isDirectory  Boolean @default(false)
  size         Int?
  mimeType     String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  owner        User     @relation(fields: [ownerId], references: [id])

  @@unique([ownerId, rootUid, fullPath])
  @@index([ownerId, rootUid, parentPath])
}
